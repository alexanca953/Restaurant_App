<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head_common}"></head>

<body>

<div th:replace="~{fragments/layout :: main_layout( ~{::section} )}">

    <section>

        <div class="page-header">
            <h1 style="font-family: 'Playfair Display', serif; color: #2c3e50;">Menu Management</h1>
            <div>
                <button onclick="openModal(0, 1, '', '', 0, '')" class="btn-add">
                    + New Product
                </button>

                <button onclick="openCategoryModal(0, '')" class="btn-add" style="background-color: #3498db; margin-left: 10px;">
                    + New Category
                </button>

                <button onclick="openDeleteCategoryModal()" class="btn-add" style="background-color: #e74c3c; margin-left: 10px;">
                    - Delete Category
                </button>
            </div>
        </div>

        <div class="table-card">
            <table class="styled-table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Category</th>
                    <th>Product Name</th>
                    <th>Price</th>
                    <th>Description</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="p : ${products}">
                    <td th:text="${'#' + p.productId}"></td>
                    <td>
                        <span style="background:#eee; padding:5px 10px; border-radius:15px; font-size:0.8em; font-weight:bold;"
                              th:text="${p.categoryId}"></span>
                    </td>
                    <td class="product-name" th:text="${p.productName}"></td>
                    <td class="price-tag" th:text="${p.price} + ' RON'"></td>
                    <td th:text="${p.description}" style="font-size:0.9em; color:#7f8c8d;"></td>
                    <td>
                        <button class="btn-icon edit"
                                th:onclick="openModal(
                                    [[${p.productId}]],
                                    [[${p.categoryId}]],
                                    [[${p.productName}]],
                                    [[${p.description}]],
                                    [[${p.price}]],
                                    [[${p.ingredients}]]
                                )">
                            Edit
                        </button>

                        <form th:action="@{/menu-management/delete}" method="post" style="display:inline;">
                            <input type="hidden" name="productId" th:value="${p.productId}">
                            <button type="submit" class="btn-icon delete"
                                    onclick="return confirm('Are you sure you want to delete this product?')">
                                Delete
                            </button>
                        </form>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div id="productModal" class="modal-overlay">
            <div class="modal-box">
                <span class="close-modal" onclick="closeProductModal()">&times;</span>
                <h2 id="modalTitle" style="font-family: 'Playfair Display'; margin-bottom: 20px;">Product</h2>

                <form th:action="@{/menu-management/save}" method="post">
                    <input type="hidden" id="inId" name="productId" value="0">

                    <div class="form-row">
                        <label>Category</label>
                        <select id="inCat" name="categoryId">
                            <option th:each="cat : ${categories}"
                                    th:value="${cat.categoryId}"
                                    th:text="${cat.name}"></option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label>Product Name</label>
                        <input type="text" id="inName" name="productName" required>
                    </div>
                    <div class="form-row">
                        <label>Price (RON)</label>
                        <input type="number" id="inPrice" name="price" step="0.1" required>
                    </div>
                    <div class="form-row">
                        <label>Description</label>
                        <textarea id="inDesc" name="description" rows="3"></textarea>
                    </div>
                    <div class="form-row">
                        <label>Ingredients</label>
                        <input type="text" id="inIngr" name="ingredients">
                    </div>
                    <button type="submit" class="btn-save">Save Product</button>
                </form>
            </div>
        </div>

        <div id="categoryModal" class="modal-overlay">
            <div class="modal-box" style="width: 400px;">
                <span class="close-modal" onclick="closeCategoryModal()">&times;</span>
                <h2 id="catModalTitle" style="font-family: 'Playfair Display'; margin-bottom: 20px;">Category</h2>

                <form th:action="@{/menu-management/save-category}" method="post">
                    <input type="hidden" id="catId" name="categoryId" value="0">
                    <div class="form-row">
                        <label>Category Name</label>
                        <input type="text" id="catName" name="name" required placeholder="Ex: Pizza...">
                    </div>
                    <button type="submit" class="btn-save" style="background-color: #3498db;">Save Category</button>
                </form>
            </div>
        </div>

        <div id="deleteCategoryModal" class="modal-overlay">
            <div class="modal-box" style="width: 400px; border-top: 5px solid #e74c3c;">
                <span class="close-modal" onclick="closeDeleteCategoryModal()">&times;</span>
                <h2 style="font-family: 'Playfair Display'; margin-bottom: 20px; color: #e74c3c;">Delete Category</h2>
                <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                    Select the category you want to remove.
                </p>

                <form th:action="@{/menu-management/delete-category}" method="post">
                    <div class="form-row">
                        <label>Select Category</label>
                        <select name="categoryId" required>
                            <option value="" disabled selected>-- Choose Category --</option>
                            <option th:each="cat : ${categories}"
                                    th:value="${cat.categoryId}"
                                    th:text="${cat.name}"></option>
                        </select>
                    </div>

                    <button type="submit" class="btn-save"
                            style="background-color: #e74c3c;"
                            onclick="return confirm('Are you sure? This might fail if products are still assigned to this category!')">
                        Delete Category
                    </button>
                </form>
            </div>
        </div>


        <script>
            // --- 1. PRODUS ---
            function openModal(id, catId, name, desc, price, ingr) {
                document.getElementById('productModal').style.display = 'block';
                document.getElementById('inId').value = id;
                document.getElementById('inCat').value = catId;
                document.getElementById('inName').value = name;
                document.getElementById('inDesc').value = desc;
                document.getElementById('inPrice').value = price;
                document.getElementById('inIngr').value = ingr;
                document.getElementById('modalTitle').innerText = (id === 0) ? "Add New Product" : "Edit " + name;
            }
            function closeProductModal() {
                document.getElementById('productModal').style.display = 'none';
            }

            // --- 2. CATEGORIE (ADD) ---
            function openCategoryModal(id, name) {
                document.getElementById('categoryModal').style.display = 'block';
                document.getElementById('catId').value = id;
                document.getElementById('catName').value = name;
                document.getElementById('catModalTitle').innerText = (id === 0) ? "Add New Category" : "Edit Category";
            }
            function closeCategoryModal() {
                document.getElementById('categoryModal').style.display = 'none';
            }

            // --- 3. CATEGORIE (DELETE) - NOU ---
            function openDeleteCategoryModal() {
                document.getElementById('deleteCategoryModal').style.display = 'block';
            }
            function closeDeleteCategoryModal() {
                document.getElementById('deleteCategoryModal').style.display = 'none';
            }

            // --- INCHIDERE GLOBALA ---
            window.onclick = function(event) {
                if (event.target == document.getElementById('productModal')) closeProductModal();
                if (event.target == document.getElementById('categoryModal')) closeCategoryModal();
                if (event.target == document.getElementById('deleteCategoryModal')) closeDeleteCategoryModal();
            }
        </script>

    </section>

</div>
</body>
</html>